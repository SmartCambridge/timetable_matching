<html>

<head>
    <title>Trip and Journey viewer</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
          integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
          crossorigin=""></script>

    <!-- Leaflet.EasyButton -->
    <!-- https://github.com/CliffCloud/Leaflet.EasyButton -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

    <!-- TableFilter -->
    <!-- -->
    <script src="tablefilter/tablefilter.js"></script>

    <!-- moment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js" integrity="sha256-CutOzxCRucUsn6C6TcEYsauvvYilEniTXldPa6/wu0k=" crossorigin="anonymous"></script>

    <!-- Leaflet.awesome-markers -->
    <!-- https://github.com/lvoogdt/Leaflet.awesome-markers -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="stylesheet" href="awesome-markers/leaflet.awesome-markers.css" />
    <script src="awesome-markers/leaflet.awesome-markers.js"></script>

    <style>

    html {
        height: 100%;
        width: 100%;
    }

    .results {
        height: 100%;
        width: 100%;
    }

    .data-table {
        height: 50%;
        overflow: scroll;
        width: 100%;
    }

    .map {
        height: 50%;
        width: 100%;

    }

    </style>

    <script type="text/javascript" src="rows-2018-09-27.js"></script>
    <script type="text/javascript" src="stops-2018-09-27.js"></script>

    <script type="text/javascript">

        var trip_marker_opts = {
            radius: 3,
            weight: 1,
            color: "blue",
            fill: true,
            stroke: true,
            fillOpacity: 0.8
        };

        var trip_line_opts = {
            color: "blue",
        };

        var trip_first = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'play-circle',
            markerColor: 'darkblue'
        });

        var trip_last = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'stop-circle',
            markerColor: 'darkblue'
        });

        var trip_departure = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'caret-right',
            markerColor: 'darkblue'
        });

        var trip_arrival = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'caret-left',
            markerColor: 'darkblue'
        });



        var journey_marker_opts = {
            radius: 3,
            weight: 1,
            color: "orange",
            fill: true,
            stroke: true,
            fillOpacity: 0.8
        };

        var journey_line_opts = {
            color: "orange",
        };

        var journey_departure = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'caret-right',
            markerColor: 'orange'
        });

        var journey_arrival = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'caret-left',
            markerColor: 'orange'
        });


        function add_heading(row, text) {
            cell = document.createElement('th');
            cell.appendChild(document.createTextNode(text));
            row.appendChild(cell);
        }

        function add_data(row, text) {
            cell = document.createElement('td');
            cell.appendChild(document.createTextNode(text));
            row.appendChild(cell);
        }

        function trip_as_html(trip) {

            var result = [];
            result.push('<p><table>');
            result.push(`<tr><th align="right">Time</th><td>${trip.OriginAimedDepartureTime}</td></tr>`);
            result.push(`<tr><th align="right">From</th><td>${trip.OriginName} (${trip.OriginRef})</td></tr>`);
            result.push(`<tr><th align="right">To</th><td>${trip.DestinationName} (${trip.DestinationRef})</td></tr>`);
            result.push(`<tr><th align="right">Line</th><td>${trip.LineRef}</td></tr>`);
            result.push(`<tr><th align="right">Operator</th><td>${trip.OperatorRef}</td></tr>`);
            result.push(`<tr><th align="right">Direction</th><td>${trip.DirectionRef}</td></tr>`);
            result.push(`<tr><th align="right">Vehicle</th><td>${trip.VehicleRef}</td></tr>`);
            result.push('</table></p>');

            return result.join(" ");
        }

        function position_as_html(position) {

            var result = [];
            result.push('<p><table>');
            result.push(`<tr><th align="right">Time</th><td>${position.RecordedAtTime}</td></tr>`);
            result.push(`<tr><th align="right">Bearing</th><td>${position.Bearing}</td></tr>`);
            result.push(`<tr><th align="right">Delay</th><td>${position.Delay}</td></tr>`);
            result.push('</table></p>');

            return result.join(" ");
        }

        function journey_as_html(journey) {

            var result = [];

            var from = stops.stops[journey.stops[0].StopPointRef];
            var to = stops.stops[journey.stops[journey.stops.length -1].StopPointRef]

            result.push('<p><table>');
            result.push(`<tr><th align="right">Time</th><td>${journey.DepartureTime}</td></tr>`);
            result.push(`<tr><th align="right">From</th><td>${from.indicator} ${from.common_name}, ${from.locality_name} (${from.atco_code})</td></tr>`);
            result.push(`<tr><th align="right">To</th><td>${to.indicator} ${to.common_name}, ${to.locality_name} (${to.atco_code})</td></tr>`);
            result.push(`<tr><th align="right">Line</th><td>${journey.Service.LineName}</td></tr>`);
            result.push(`<tr><th align="right">Operator</th><td>${journey.Service.OperatorCode}</td></tr>`);
            result.push(`<tr><th align="right">Direction</th><td>${journey.Direction}</td></tr>`);
            result.push('</table></p>');

            return result.join(" ");
        }


        function stop_as_html(stop) {
            return(`<p>${stop.indicator} ${stop.common_name}, ${stop.locality_name} (${stop.atco_code})</p>`)
        }

        function journey_stop_as_html(stop) {
            var full_stop = stops.stops[stop.StopPointRef];
            var result = [];
            result.push('<p><table>');
            result.push(`<tr><th align="right">Time</th><td>${stop.time}</td></tr>`);
            result.push(`<tr><th align="right">Activity</th><td>${stop.Activity}</td></tr>`);
            result.push(`<tr><th align="right">Order</th><td>${stop.Order}</td></tr>`);
            result.push(`<tr><th align="right">Timing status</th><td>${stop.TimingStatus}</td></tr>`);
            result.push(`<tr><th align="right">Run timr</th><td>${stop.run_time}</td></tr>`);
            result.push(`<tr><th align="right">ATCO Code</th><td>${full_stop.atco_code}</td></tr>`);
            result.push(`<tr><th align="right">Common name</th><td>${full_stop.common_name}</td></tr>`);
            result.push(`<tr><th align="right">Indicator</th><td>${full_stop.indicator}</td></tr>`);
            result.push(`<tr><th align="right">Locality name</th><td>${full_stop.locality_name}</td></tr>`);
            result.push('</table></p>');

            return result.join(" ");
        }

        function init() {

            map = L.map('map');
            trip_layer = L.layerGroup();
            journey_layer = L.layerGroup();

            function display_trip(row_num) {

                var trip = data.rows[row_num].trip;
                var polyline = L.polyline([], trip_line_opts);
                polyline.addTo(trip_layer);
                polyline.bindPopup(trip_as_html(trip))
                trip.positions.forEach(function(position, index, positions) {
                    polyline.addLatLng([position.Latitude, position.Longitude]);
                    if (index == trip.departure_position) {
                        L.marker([position.Latitude, position.Longitude], {icon: trip_departure}).addTo(trip_layer)
                    }
                    else if (index == trip.arrival_position) {
                        L.marker([position.Latitude, position.Longitude], {icon: trip_arrival}).addTo(trip_layer)
                    }
                    else if (index === 0) {
                        L.marker([position.Latitude, position.Longitude], {icon: trip_first}).addTo(trip_layer)
                    }
                    else if (index === (positions.length -1)) {
                        L.marker([position.Latitude, position.Longitude], {icon: trip_last}).addTo(trip_layer)
                    }
                    L.circleMarker([position.Latitude, position.Longitude], trip_marker_opts)
                        .bindPopup(position_as_html(position)).addTo(trip_layer);
                });

                var origin = stops.stops[trip.OriginRef]
                var origin_marker = L.circleMarker([origin.latitude, origin.longitude], trip_marker_opts)
                    .bindPopup(stop_as_html(origin));
                origin_marker.setStyle({color: "blue", radius: 10, fill: false, weight: 2 });
                origin_marker.addTo(trip_layer);

                var destination = stops.stops[trip.DestinationRef]
                var destination_marker = L.circleMarker([destination.latitude, destination.longitude], trip_marker_opts)
                    .bindPopup(stop_as_html(destination));
                destination_marker.setStyle({color: "blue", radius: 10, fill: false, weight: 2 });
                destination_marker.addTo(trip_layer);

                map.fitBounds(polyline.getBounds().extend(origin_marker.getLatLng()).extend(destination_marker.getLatLng()));

            }

            function display_journey(row_num) {

                var journey = data.rows[row_num].journey;
                var polyline = L.polyline([], journey_line_opts);
                polyline.addTo(journey_layer);
                polyline.bindPopup(journey_as_html(journey))

                journey.stops.forEach(function(stop, index, journey_stops) {
                    var full_stop = stops.stops[stop.StopPointRef];
                    polyline.addLatLng([full_stop.latitude, full_stop.longitude]);
                    marker = L.circleMarker([full_stop.latitude, full_stop.longitude], journey_marker_opts)
                        .bindPopup(journey_stop_as_html(stop));
                    marker.addTo(journey_layer);
                    if (index === 0) {
                        L.marker([full_stop.latitude, full_stop.longitude], {icon: journey_departure}).addTo(journey_layer);
                    }
                    else if (index === (journey_stops.length -1)) {
                        L.marker([full_stop.latitude, full_stop.longitude], {icon: journey_arrival}).addTo(journey_layer);
                    }
                    marker.addTo(journey_layer);
                });

                map.fitBounds(polyline.getBounds());

            }

            var table = document.createElement('table');

            var trow = document.createElement('tr');
            add_heading(trow, '');
            add_heading(trow, 'Type');
            add_heading(trow, 'Date');
            add_heading(trow, 'Time');
            add_heading(trow, 'From');
            add_heading(trow, 'To');

            add_heading(trow, 'Journey: Line');
            add_heading(trow, 'Journey: Depart');
            add_heading(trow, 'Journey: Arrive');
            add_heading(trow, '');

            add_heading(trow, '');

            add_heading(trow, '');
            add_heading(trow, 'Trip: Line');
            add_heading(trow, 'Trip: Vehicle');
            add_heading(trow, 'Trip: Depart');
            add_heading(trow, 'Trip: Arrive');

            add_heading(trow, 'Delay: Departure');
            add_heading(trow, 'Delay: Arrival');

            var thead = document.createElement('thead');
            thead.appendChild(trow);
            table.appendChild(thead);

            var counter = 0;

            var tbody = document.createElement('tbody');

            data.rows.forEach(function(row) {
                var trow = document.createElement('tr');
                if (row.type !== '1-1') {
                    trow.classList.add('mismatch');
                }

                add_heading(trow, counter+1);

                add_data(trow, row.type);
                timestamp = moment(row.time)
                add_data(trow, timestamp.format("YYYY-MM-DD"));
                add_data(trow, timestamp.format("HH:mm"));
                add_data(trow, row.origin_desc);
                add_data(trow, row.destination_desc);

                if (row.journey) {
                    add_data(trow, row.journey.Service.LineName);
                    add_data(trow, moment(row.journey.stops[0].time).format("HH:mm"));
                    add_data(trow, moment(row.journey.stops[row.journey.stops.length - 1].time).format("HH:mm"));
                    var a = document.createElement('a');
                    a.setAttribute('href', '#');
                    a.onclick = function(c) {
                        return function() {
                            display_journey(c);
                            return false;
                        };
                    }(counter);
                    a.appendChild(document.createTextNode('Show'));
                    cell = document.createElement('td');
                    cell.appendChild(a);
                    trow.appendChild(cell);
                }
                else {
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                }

                add_data(trow, row.separator);

                if (row.trip) {
                    var a = document.createElement('a');
                    a.setAttribute('href', '#');
                    a.onclick = function(c) {
                        return function() {
                            display_trip(c);
                            return false;
                        };
                    }(counter);
                    a.appendChild(document.createTextNode('Show'));
                    cell = document.createElement('td');
                    cell.appendChild(a);
                    trow.appendChild(cell);
                    add_data(trow, row.trip.LineRef);
                    add_data(trow, row.trip.VehicleRef);
                    if (row.trip.departure_position !== null) {
                        add_data(trow, moment(row.trip.positions[row.trip.departure_position].RecordedAtTime).format("HH:mm"));
                    }
                    else {
                        add_data(trow, '');
                    }
                    if (row.trip.arrival_position !== null) {
                        add_data(trow, moment(row.trip.positions[row.trip.arrival_position].RecordedAtTime).format("HH:mm"));
                    }
                    else {
                        add_data(trow, '');
                    }
                }
                else {
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                }

                add_data(trow, row.departure_delay);
                add_data(trow, row.arrival_delay);

                tbody.appendChild(trow);

                counter += 1;

            });

            table.appendChild(tbody);

            var results = document.getElementById('data-table');
            results.appendChild(table);

            var tf_config = {
                base_path: 'tablefilter/',
                //col_1: 'checklist',
                //col_4: 'checklist',
                //col_5: 'checklist',
                //col_6: 'checklist',
                //col_7: 'checklist',
                //col_8: 'checklist',
                //col_13: 'checklist',
                //col_14: 'checklist',
                //col_15: 'checklist',
                alternate_rows: true,
                rows_counter: true,
                btn_reset: true,
                status_bar: true,
            }

            var tf = new TableFilter(table, tf_config);
            tf.init();

            var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
               attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
               maxZoom: 19
            });
            map.addLayer(osm);
            map.addLayer(trip_layer);
            map.addLayer(journey_layer);
            L.control.scale().addTo(map);

            L.easyButton('fa-trash-alt', function(btn, map) {
                trip_layer.clearLayers();
                journey_layer.clearLayers();
                map.fitBounds(area.getBounds());
            }).addTo(map);

            // Mark the selection bounding box
            var area = L.rectangle([[52.155610, 0.007896], [52.267842, 0.225048]], {color: "#000000", weight: 1, fill: false}).addTo(map);
            map.fitBounds(area.getBounds());

        }

    </script>

</head>

<body onload="init()">

    <div class="results">
        <div id="data-table" class="data-table"></div>
        <div id="map" class="map"></div>
    </div>

</body>

</html>