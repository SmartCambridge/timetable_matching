<html>

<head>
    <title>Trip and Journey viewer</title>

    <script type="text/javascript" src="results/rows-2018-09-30.js"></script>
    <script type="text/javascript" src="results/stops-2018-09-30.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
          integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
          crossorigin=""></script>

    <!-- Leaflet.EasyButton -->
    <!-- https://github.com/CliffCloud/Leaflet.EasyButton -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

    <!-- TableFilter -->
    <!-- -->
    <script src="tablefilter/tablefilter.js"></script>

    <!-- moment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js" integrity="sha256-CutOzxCRucUsn6C6TcEYsauvvYilEniTXldPa6/wu0k=" crossorigin="anonymous"></script>

    <!-- Leaflet.awesome-markers -->
    <!-- https://github.com/lvoogdt/Leaflet.awesome-markers -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="stylesheet" href="awesome-markers/leaflet.awesome-markers.css" />
    <script src="awesome-markers/leaflet.awesome-markers.js"></script>

    <!-- Leaflet.PolyLineDecerator -->
    <!-- https://github.com/bbecquet/Leaflet.PolylineDecorator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.js" integrity="sha256-1Unbn4Jf/36y7z5KHisWSKgLT4K1NofaiZRpzz6Hq2E=" crossorigin="anonymous"></script>

    <style>

    html {
        height: 100%;
        width: 100%;
    }

    .results {
        height: 100%;
        width: 100%;
    }

    .data-table {
        height: 50%;
        overflow: scroll;
        width: 100%;
    }

    .map {
        height: 50%;
        width: 100%;

    }

    .popup th, .popup td {
        vertical-align: top;
    }

    </style>

    <script type="text/javascript">

        // https://sashat.me/2017/01/11/list-of-20-simple-distinct-colors/
        var colors = [
            "#e6194B", "#3cb44b", "#4363d8", "#f58231", "#911eb4", "#f032e6",
            "#469990", "#9A6324", "#800000", "#808000", "#000075", "#000000"];

        var trip_marker_opts = {
            radius: 3,
            weight: 2,
            fill: true,
            stroke: true,
            fillOpacity: 0.8
        };

        var trip_line_opts = {
            weight: 3,
        };

        var trip_departure = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'play-circle',
            markerColor: 'darkblue'
        });

        var trip_arrival = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'stop-circle',
            markerColor: 'darkblue'
        });

        var journey_marker_opts = {
            radius: 4,
            weight: 2,
            fill: false,
            stroke: true,
        };

        var journey_line_opts = {
            dashArray: "5",
            weight: 2,
        };

        var journey_departure = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'caret-right',
            markerColor: 'orange'
        });

        var journey_arrival = L.AwesomeMarkers.icon({
            prefix: 'fa',
            icon: 'caret-left',
            markerColor: 'orange'
        });

        function as_minutes(seconds) {
            if (seconds === null || seconds === '') {
                return ''
            }
            else {
                return (seconds/60).toFixed(2)
            }
        }

        var map;

        var journey_layers = {};
        var trip_layers = {};

        var line_colors = {};
        var next_color = 0;

        function get_color(row) {
            if (line_colors.hasOwnProperty(row)) {
                return line_colors[row];
            }
            else {
                color = colors[next_color % colors.length];
                line_colors[row] = color;
                next_color += 1;
                return color;
            }
        }

        function display_trip(row_num) {

            var element = document.getElementById('trip-' + row_num);

            if (trip_layers.hasOwnProperty(row_num)) {
                map.removeLayer(trip_layers[row_num]);
                delete trip_layers[row_num];
                element.innerHTML = 'Show';
            }

            else {

                var layer = L.layerGroup();

                color = get_color(row_num);

                var trip = data.rows[row_num].trip;
                var polyline = L.polyline([], trip_line_opts);
                polyline.setStyle({color: color});
                polyline.addTo(layer);
                polyline.bindPopup(trip_as_html(trip, row_num));
                trip.positions.forEach(function(position, index, positions) {
                    polyline.addLatLng([position.Latitude, position.Longitude]);
                    if (index == trip.departure_position) {
                        L.marker([position.Latitude, position.Longitude], {icon: trip_departure})
                        .bindPopup(position_as_html(position, index))
                        .addTo(layer);
                    }
                    else if (index == trip.arrival_position) {
                        L.marker([position.Latitude, position.Longitude], {icon: trip_arrival})
                        .bindPopup(position_as_html(position, index))
                        .addTo(layer);
                    }
                    L.circleMarker([position.Latitude, position.Longitude], trip_marker_opts)
                        .setStyle({color: color})
                        .bindPopup(position_as_html(position, index)).addTo(layer);
                });
                L.polylineDecorator(polyline, {
                    patterns: [ {
                        offset: 25,
                        repeat: 75,
                        symbol: L.Symbol.arrowHead( {
                            pixelSize: 15,
                            polygon: false,
                            pathOptions: {
                                stroke: true,
                                color: color,
                            }
                        } )
                    } ]
                } ).addTo(layer);

                var origin = stops.stops[trip.OriginRef];
                var origin_marker = L.circleMarker([origin.latitude, origin.longitude], trip_marker_opts)
                    .bindPopup(stop_as_html(origin));
                origin_marker.setStyle({color: color, radius: 10, fill: false, weight: 2 });
                origin_marker.addTo(layer);

                var destination = stops.stops[trip.DestinationRef];
                var destination_marker = L.circleMarker([destination.latitude, destination.longitude], trip_marker_opts)
                    .bindPopup(stop_as_html(destination));
                destination_marker.setStyle({color: color, radius: 10, fill: false, weight: 2 });
                destination_marker.addTo(layer);

                trip_layers[row_num] = layer;
                map.addLayer(layer);

                element.innerHTML = '<b>Hide</b>';

                //map.fitBounds(polyline.getBounds().extend(origin_marker.getLatLng()).extend(destination_marker.getLatLng()));

            }

        }

        function display_journey(row_num) {

            var element = document.getElementById('journey-' + row_num);

            if (journey_layers.hasOwnProperty(row_num)) {
                map.removeLayer(journey_layers[row_num]);
                delete journey_layers[row_num];
                element.innerHTML = 'Show';
            }

            else {
                var layer = L.layerGroup();
                color = get_color(row_num);

                var journey = data.rows[row_num].journey;
                var polyline = L.polyline([], journey_line_opts);
                polyline.setStyle({color: color})
                polyline.addTo(layer);
                polyline.bindPopup(journey_as_html(journey, row_num));

                journey.stops.forEach(function(stop, index, journey_stops) {
                    var full_stop = stops.stops[stop.StopPointRef];
                    polyline.addLatLng([full_stop.latitude, full_stop.longitude]);
                    marker = L.circleMarker([full_stop.latitude, full_stop.longitude], journey_marker_opts)
                        .setStyle({color: color})
                        .bindPopup(journey_stop_as_html(stop));
                    marker.addTo(layer);
                });
                L.polylineDecorator(polyline, {
                    patterns: [ {
                        offset: 25,
                        repeat: 75,
                        symbol: L.Symbol.arrowHead( {
                            pixelSize: 15,
                            polygon: false,
                            pathOptions: {
                                stroke: true,
                                color: color,
                            }
                        } )
                    } ]
                } ).addTo(layer);

                journey_layers[row_num] = layer;
                map.addLayer(layer);

                element.innerHTML = '<b>Hide</b>';

                //map.fitBounds(polyline.getBounds());

            }

        }

        function add_heading(row, text) {
            cell = document.createElement('th');
            cell.appendChild(document.createTextNode(text));
            row.appendChild(cell);
        }

        function add_data(row, text) {
            cell = document.createElement('td');
            cell.appendChild(document.createTextNode(text));
            row.appendChild(cell);
        }

        function trip_as_html(trip, counter) {

            var result = [];
            var timestamp = moment(trip.OriginAimedDepartureTime);
            result.push('<h1>Trip</h1>')
            result.push('<table class="popup">');
            result.push(`<tr><th align="right">Date</th><td>${timestamp.format("YYYY-MM-DD")}</td></tr>`);
            result.push(`<tr><th align="right">Time</th><td>${timestamp.format("HH:mm")}</td></tr>`);
            result.push(`<tr><th align="right">From</th><td>${trip.OriginName} (${trip.OriginRef})</td></tr>`);
            result.push(`<tr><th align="right">To</th><td>${trip.DestinationName} (${trip.DestinationRef})</td></tr>`);
            result.push(`<tr><th align="right">Line</th><td>${trip.LineRef}</td></tr>`);
            result.push(`<tr><th align="right">Operator</th><td>${trip.OperatorRef}</td></tr>`);
            result.push(`<tr><th align="right">Direction</th><td>${trip.DirectionRef}</td></tr>`);
            result.push(`<tr><th align="right">Vehicle</th><td>${trip.VehicleRef}</td></tr>`);
            result.push('</table>');
            result.push(`<p><a href="#" onclick="display_trip(${counter}); return false">Hide this trip</a></p>`);
            return result.join(" ");
        }

        function position_as_html(position, index) {

            var result = [];
            var timestamp = moment(position.RecordedAtTime);
            result.push('<h1>Position</h1>')
            result.push('<table class="popup">');
            result.push(`<tr><th align="right">Date</th><td>${timestamp.format("YYYY-MM-DD")}</td></tr>`);
            result.push(`<tr><th align="right">Time</th><td>${timestamp.format("HH:mm")}</td></tr>`);
            result.push(`<tr><th align="right">Bearing</th><td>${position.Bearing}</td></tr>`);
            result.push(`<tr><th align="right">Order</th><td>${index}</td></tr>`);
            result.push(`<tr><th align="right">Delay</th><td>${position.Delay}</td></tr>`);
            result.push('</table>');

            return result.join(" ");
        }

        function journey_as_html(journey, counter) {

            var result = [];

            var from = stops.stops[journey.stops[0].StopPointRef];
            var to = stops.stops[journey.stops[journey.stops.length -1].StopPointRef]

            var timestamp = moment(journey.DepartureTime);

            result.push('<h1>Journey</h1>');
            result.push('<table class="popup">');
            result.push(`<tr><th align="right">Date</th><td>${timestamp.format("YYYY-MM-DD")}</td></tr>`);
            result.push(`<tr><th align="right">Time</th><td>${timestamp.format("HH:mm")}</td></tr>`);
            result.push(`<tr><th align="right">From</th><td>${from.indicator} ${from.common_name}, ${from.locality_name} (${from.atco_code})</td></tr>`);
            result.push(`<tr><th align="right">To</th><td>${to.indicator} ${to.common_name}, ${to.locality_name} (${to.atco_code})</td></tr>`);
            result.push(`<tr><th align="right">Line</th><td>${journey.Service.LineName}</td></tr>`);
            result.push(`<tr><th align="right">Operator</th><td>${journey.Service.OperatorCode}</td></tr>`);
            result.push(`<tr><th align="right">Direction</th><td>${journey.Direction}</td></tr>`);
            result.push('</table>')
            result.push(`<p><a href="#" onclick="display_journey(${counter}); return false">Hide this journey</a></p>`);

            return result.join(" ");
        }


        function stop_as_html(stop) {
            return(`<h1>Stop</h1><p>${stop.indicator} ${stop.common_name}, ${stop.locality_name} (${stop.atco_code})</p>`)
        }

        function journey_stop_as_html(stop) {
            var full_stop = stops.stops[stop.StopPointRef];
            var result = [];
            var timestamp = moment(stop.time);
            result.push('<h1>Journey stop</h1>');
            result.push('<table class="popup">');
            result.push(`<tr><th align="right">Date</th><td>${timestamp.format("YYYY-MM-DD")}</td></tr>`);
            result.push(`<tr><th align="right">Time</th><td>${timestamp.format("HH:mm")}</td></tr>`);
            result.push(`<tr><th align="right">Activity</th><td>${stop.Activity}</td></tr>`);
            result.push(`<tr><th align="right">Order</th><td>${stop.Order}</td></tr>`);
            result.push(`<tr><th align="right">Timing status</th><td>${stop.TimingStatus}</td></tr>`);
            result.push(`<tr><th align="right">Run time</th><td>${stop.run_time}</td></tr>`);
            result.push(`<tr><th align="right">ATCO Code</th><td>${full_stop.atco_code}</td></tr>`);
            result.push(`<tr><th align="right">Common name</th><td>${full_stop.common_name}</td></tr>`);
            result.push(`<tr><th align="right">Indicator</th><td>${full_stop.indicator}</td></tr>`);
            result.push(`<tr><th align="right">Locality name</th><td>${full_stop.locality_name}</td></tr>`);
            result.push('</table>');

            return result.join(" ");
        }

        function init() {

            map = L.map('map');

            var table = document.createElement('table');

            var trow = document.createElement('tr');
            add_heading(trow, '');
            add_heading(trow, 'Type');
            add_heading(trow, 'Date');
            add_heading(trow, 'Time');
            add_heading(trow, 'From');
            add_heading(trow, 'To');

            add_heading(trow, 'Journey: Line');
            add_heading(trow, 'Journey: Direction');
            add_heading(trow, 'Journey: Depart');
            add_heading(trow, 'Journey: Arrive');
            add_heading(trow, '');

            add_heading(trow, '');

            add_heading(trow, '');
            add_heading(trow, 'Trip: Line');
            add_heading(trow, 'Trip: Vehicle');
            add_heading(trow, 'Trip: Depart');
            add_heading(trow, 'Trip: Arrive');

            add_heading(trow, 'Delay (min): Departure');
            add_heading(trow, 'Delay (min): Arrival');

            var thead = document.createElement('thead');
            thead.appendChild(trow);
            table.appendChild(thead);

            var counter = 0;

            var tbody = document.createElement('tbody');

            data.rows.forEach(function(row) {
                var trow = document.createElement('tr');
                if (row.type !== '1-1') {
                    trow.classList.add('mismatch');
                }

                add_heading(trow, counter+1);

                add_data(trow, row.type);
                timestamp = moment(row.time)
                add_data(trow, timestamp.format("YYYY-MM-DD"));
                add_data(trow, timestamp.format("HH:mm"));
                add_data(trow, row.origin_desc);
                add_data(trow, row.destination_desc);

                if (row.journey) {
                    add_data(trow, row.journey.Service.LineName);
                    add_data(trow, row.journey.Direction)
                    add_data(trow, moment(row.journey.stops[0].time).format("HH:mm"));
                    add_data(trow, moment(row.journey.stops[row.journey.stops.length - 1].time).format("HH:mm"));
                    var a = document.createElement('a');
                    a.setAttribute('href', '#');
                    a.onclick = function(c) {
                        return function() {
                            display_journey(c);
                            return false;
                        };
                    }(counter);
                    a.id = 'journey-' + counter;
                    a.innerHTML = 'Show';
                    cell = document.createElement('td');
                    cell.appendChild(a);
                    trow.appendChild(cell);
                }
                else {
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                }

                add_data(trow, row.separator);

                if (row.trip) {
                    var a = document.createElement('a');
                    a.setAttribute('href', '#');
                    a.onclick = function(c) {
                        return function() {
                            display_trip(c);
                            return false;
                        };
                    }(counter);
                    a.id = 'trip-' + counter;
                    a.innerHTML = 'Show';
                    cell = document.createElement('td');
                    cell.appendChild(a);
                    trow.appendChild(cell);
                    add_data(trow, row.trip.LineRef);
                    add_data(trow, row.trip.VehicleRef);
                    if (row.trip.departure_position !== null) {
                        add_data(trow, moment(row.trip.positions[row.trip.departure_position].RecordedAtTime).format("HH:mm"));
                    }
                    else {
                        add_data(trow, '');
                    }
                    if (row.trip.arrival_position !== null) {
                        add_data(trow, moment(row.trip.positions[row.trip.arrival_position].RecordedAtTime).format("HH:mm"));
                    }
                    else {
                        add_data(trow, '');
                    }
                }
                else {
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                    add_data(trow, '');
                }

                add_data(trow, as_minutes(row.departure_delay));
                add_data(trow, as_minutes(row.arrival_delay));

                tbody.appendChild(trow);

                counter += 1;

            });

            table.appendChild(tbody);

            var results = document.getElementById('data-table');
            results.appendChild(table);

            var tf_config = {
                base_path: 'tablefilter/',
                //col_1: 'checklist',
                //col_4: 'checklist',
                //col_5: 'checklist',
                //col_6: 'checklist',
                //col_7: 'checklist',
                //col_8: 'checklist',
                //col_13: 'checklist',
                //col_14: 'checklist',
                //col_15: 'checklist',
                alternate_rows: true,
                rows_counter: true,
                btn_reset: true,
                status_bar: true,
                sticky_headers: true
            }

            var tf = new TableFilter(table, tf_config);
            tf.init();

            var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
               attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
               maxZoom: 19
            });
            map.addLayer(osm);
            L.control.scale().addTo(map);

            L.easyButton('fa-trash-alt', function(btn, map) {
                for (var row in journey_layers) {
                    if (journey_layers.hasOwnProperty(row)) {
                        display_journey(row);
                    }
                }
                for (row in trip_layers) {
                    if (trip_layers.hasOwnProperty(row)) {
                        display_trip(row);
                    }
                }
                line_colors = {};
                next_color = 0;
            }).addTo(map);

            // Mark the selection bounding box
            var area = L.rectangle([[52.155610, 0.007896], [52.267842, 0.225048]], {color: "#000000", weight: 1, fill: false}).addTo(map);
            map.fitBounds(area.getBounds());

        }

    </script>

</head>

<body onload="init()">

    <div class="results">
        <div id="data-table" class="data-table"></div>
        <div id="map" class="map"></div>
    </div>

</body>

</html>